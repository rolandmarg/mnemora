# Cursor Rules for Mnemora

## Project Overview
Mnemora is a TypeScript bot that fetches Google Calendar birthdays and sends WhatsApp notifications. The application is **primarily deployed on AWS Lambda** and **runs once per day** via scheduled execution. The project uses:
- **TypeScript** with strict type checking
- **ES Modules** (ESM) - all imports use `.js` extension
- **Yarn** as package manager
- **AWS Lambda** as the primary deployment platform (runs once daily)
- **Google Calendar API** for calendar operations
- **WhatsApp Web.js** for WhatsApp messaging
- **macOS** as the primary development platform
- **zsh** as the preferred shell (macOS default since Catalina)

## Project Structure
```
src/
├── services/          # Core business logic services
│   ├── birthday.service.ts    # Birthday checking and digest logic
│   ├── birthday-orchestrator.service.ts  # Main orchestration service
│   └── [other services]
├── scripts/           # CLI scripts for manual operations
│   ├── delete-events.ts
│   ├── get-todays-birthdays.ts
│   ├── get-monthly-digest.ts
│   ├── get-todays-birthdays-with-digest.ts
│   ├── get-all-birthdays.ts
│   ├── manual-send.ts
│   └── send-monthly-digest-whatsapp.ts
├── clients/           # External API clients
│   ├── google-calendar.client.ts
│   ├── google-sheets.client.ts
│   ├── whatsapp.client.ts
│   └── [other clients]
├── utils/             # Shared utility functions
│   ├── date-helpers.util.ts    # Date manipulation utilities
│   ├── birthday-helpers.util.ts
│   ├── name-helpers.util.ts
│   ├── event-helpers.util.ts
│   └── [other utilities]
├── types/             # TypeScript type definitions
│   └── qrcode-terminal.d.ts
├── config.ts          # Configuration loader
└── index.ts           # Main entry point
```

You are an expert in TypeScript, Node.js.
  
  Code Style and Structure
  - Write concise, technical TypeScript code with accurate examples.
  - Use functional and declarative programming patterns; avoid classes.
  - Prefer iteration and modularization over code duplication.
  - Use descriptive variable names with auxiliary verbs (e.g., isLoading, hasError).
  - Prefer compact, easy to understand code.

## Code Style & Conventions

### TypeScript
- Use strict TypeScript with all strict checks enabled
- Always use explicit types, avoid `any`
- Use interfaces for object shapes
- Prefer `type` for unions and intersections
- Use ES module syntax (`import`/`export`)
- **CRITICAL**: Always use nullish coalescing operator (`??`) instead of logical OR (`||`) for default values. The `??` operator only checks for `null` or `undefined`, while `||` also treats falsy values (0, '', false) as needing defaults, which can cause bugs. Example: `const value = obj.prop ?? defaultValue` NOT `const value = obj.prop || defaultValue`

### Imports
- Always use `.js` extension in import paths (TypeScript requirement for ESM)
- Example: `import { config } from '../config.js';`
- **CRITICAL for Runtime**: Subpath imports from node_modules packages MUST also include `.js` extension
  - ✅ Correct: `import baileysLogger from '@whiskeysockets/baileys/lib/Utils/logger.js';`
  - ❌ Wrong: `import baileysLogger from '@whiskeysockets/baileys/lib/Utils/logger';` (will fail at runtime in Lambda)
  - Main package imports (e.g., `from '@whiskeysockets/baileys'`) don't need extension, but subpath imports do
- Group imports: external packages, then internal modules

### Naming Conventions
- **Files**: kebab-case (e.g., `add-birthday.ts`)
- **Classes**: PascalCase (e.g., `CalendarService`)
- **Functions/Variables**: camelCase (e.g., `getEventsForDate`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `MAX_RESULTS`)
- **Interfaces**: PascalCase (e.g., `BirthdayInput`)

### Code Organization
- Services should be singleton classes exported as default instances
- Scripts should be standalone executable files
- Utilities should be pure functions when possible
- Always handle errors with try/catch and meaningful error messages
- **Function Parameters**: Functions with 4 or more parameters MUST use an object parameter instead of positional arguments for better readability and maintainability

## Utilities Available

### Date Utilities (`src/utils/date-helpers.util.ts`)
- `startOfDay(date)` - Normalize to start of day (00:00:00)
- `endOfDay(date)` - Normalize to end of day (23:59:59.999)
- `formatDateISO(date)` - Format as YYYY-MM-DD
- `startOfMonth(date)` - Get start of month
- `endOfMonth(date)` - Get end of month
- `startOfYear(date)` - Get start of year
- `endOfYear(date)` - Get end of year
- `isFirstDayOfMonth(date)` - Check if date is first day of month
- `formatDateShort(date, includeYear?)` - Format date as short string
- `formatDateMonthYear(date)` - Format date as month and year
- `parseDateFromString(dateString)` - Parse date from string
- `parseDateString(dateStr)` - Parse date string with various formats
- `today()` - Get today's date in configured timezone

### Birthday Utilities (`src/utils/birthday-helpers.util.ts`)
- `parseRowToBirthdays(row)` - Parse spreadsheet row to birthday records
- `getDateRangeForBirthdays(birthdays)` - Get date range for birthday records

### Name Utilities (`src/utils/name-helpers.util.ts`)
- `getFullName(firstName, lastName?)` - Get full name
- `sanitizeNames(firstName, lastName?)` - Sanitize name strings
- `extractNameParts(fullName)` - Extract first and last name from full name

### Event Utilities (`src/utils/event-helpers.util.ts`)
- `isBirthdayEvent(event)` - Check if event is a birthday event
- `extractNameFromEvent(event)` - Extract name from event

## Common Patterns

### Adding New Scripts
1. Create script in `src/scripts/`
2. Use utilities from `src/utils/` when possible
3. Add script to `package.json` scripts section
4. Add debug configuration to `.vscode/launch.json`
5. **IMPORTANT**: Ensure `package.json` and `.vscode/launch.json` are kept in sync
6. Use `calendarClient` from `src/clients/google-calendar.client.ts` for calendar operations
7. Use `appContext` from `src/app-context.ts` for application context

### Calendar Operations
- **Read operations**: Use `calendarClient` from `src/clients/google-calendar.client.ts`
- **Write operations**: Use `calendarClient` with appropriate methods
- Always use `startOfDay()` and `endOfDay()` for date ranges
- Use `config.google.calendarId` for calendar ID (defaults to 'primary')

### Error Handling
- Always wrap async operations in try/catch
- Provide meaningful error messages
- Log errors with `console.error()`
- Use `process.exit()` appropriately in scripts

### Date Handling
- Always normalize dates using utilities (`startOfDay`, `endOfDay`)
- Use `formatDateISO()` for ISO date strings
- Be aware of timezone issues (use UTC for all-day events)

## Best Practices

1. **Reuse Code**: Always check `src/utils/` before writing new utility functions
2. **Type Safety**: Never use `any`, always provide proper types
3. **Error Messages**: Make error messages helpful and actionable
4. **Consistency**: Follow existing patterns in the codebase
5. **Before Committing**: Run `yarn type-check` and `yarn lint` before committing
6. **After Big Changes**: Always run typecheck and lint after making significant changes
7. **Scripts**: Always add new scripts to `package.json` and `launch.json` - keep them in sync
8. **Linting**: Follow ESLint rules - use `yarn lint:fix` to auto-fix issues
9. **Documentation**: Do NOT add JSDoc type comments - TypeScript types are sufficient
10. **Function Parameters**: Functions with 4+ arguments MUST use an object parameter pattern. Create an interface/type for the options object. This improves readability, allows optional parameters, and makes the API more maintainable.
11. **Documentation Files Are Valuable**: All `.md` files and documentation are valuable information sources. When making changes:
    - Read and understand existing documentation before modifying code
    - Preserve important information, context, and lessons learned in documentation
    - Update documentation when making changes that affect it
    - Do NOT delete or significantly alter documentation without understanding its purpose
    - Documentation in `docs/` (especially `docs/bugs-fixes/`) contains critical incident reports, root cause analyses, and solutions - treat these as valuable knowledge

## Environment Variables
- `GOOGLE_CALENDAR_ID` - Calendar ID (defaults to 'primary')
- `GOOGLE_CLIENT_EMAIL` - Service account email
- `GOOGLE_PRIVATE_KEY` - Service account private key
- `GOOGLE_PROJECT_ID` - Google Cloud project ID
- `WHATSAPP_GROUP_ID` - WhatsApp group ID
- `SCHEDULE_TIME` - Schedule time in 24-hour format (defaults to '09:00')

## Commands
- `yarn build` - Build TypeScript
- `yarn start` - Run compiled JavaScript
- `yarn dev` - Development mode with auto-reload
- `yarn type-check` - Type check without building
- `yarn lint` - Run ESLint to check code quality
- `yarn lint:fix` - Run ESLint and auto-fix issues
- `yarn get-todays-birthdays` - Get today's birthdays
- `yarn get-monthly-digest` - Get monthly digest
- `yarn get-todays-birthdays-with-digest` - Get today's birthdays + monthly digest
- `yarn get-all-birthdays` - Read from Sheets, sync to Calendar, display all
- `yarn delete-events` - Delete events interactively
- `yarn manual-send` - Manually send monthly digest + today's birthdays
- `yarn send-monthly-digest-whatsapp` - Send monthly digest to WhatsApp group

## When Adding New Features

1. **Check utilities first** - Don't duplicate existing functionality
2. **Follow existing patterns** - Match the style of similar code
3. **Update documentation** - Add to README if needed
4. **Add to launch.json** - Include debug configuration for scripts
5. **Keep in sync** - Ensure `package.json` and `.vscode/launch.json` are synchronized
6. **Type check** - Always run `yarn type-check` before committing
7. **Use shared utilities** - Leverage existing CLI, date, and auth utilities
8. **After big changes** - Run typecheck (`yarn type-check`) and lint (`yarn lint`) to verify everything works

## Important Notes

- All imports must use `.js` extension (TypeScript ESM requirement)
- Always normalize dates with `startOfDay()` and `endOfDay()`
- Scripts should handle their own process.exit() calls
- Use `appContext` from `src/app-context.ts` for application context and logger
- Use `BirthdayService` from `src/services/birthday.service.ts` for birthday operations
- Use `OutputChannelFactory` from `src/output-channel/output-channel.factory.js` for output channels
- **Do NOT add JSDoc type comments** - TypeScript provides type information, JSDoc type annotations are redundant
- **After significant changes**: Run `yarn type-check && yarn lint` to ensure everything is working
- **Keep `package.json` and `.vscode/launch.json` synchronized** - When adding scripts, update both files
- **⚠️ Version Locking**: **ALL dependencies MUST be locked to exact versions** - NEVER use caret (`^`) or tilde (`~`) prefixes. Always use exact version numbers (e.g., `"package": "1.2.3"` not `"package": "^1.2.3"`). This ensures reproducible builds and prevents unexpected breaking changes in Lambda deployments.
- **⚠️ Baileys Version Lock**: `@whiskeysockets/baileys` MUST be locked to exactly `6.7.21` (no `^` or `~`). Versions 6.17.16+ introduce audio decoder dependencies (~22MB) and lodash+libphonenumber-js (~10MB), increasing Lambda package size from ~37MB to ~60MB+. Always use exact version: `"@whiskeysockets/baileys": "6.7.21"`

## Deployment & Runtime

- **Primary Deployment**: AWS Lambda
- **Execution Schedule**: Runs once per day (scheduled execution)
- **Lambda Handlers**: Located in `src/lambda/`
  - `handler.ts` - Main Lambda entry point
  - `daily-summary-handler.ts` - Daily summary handler
- **Package Size**: Keep Lambda package size minimal (see Baileys version warning below)
- **Build Scripts**: Use `yarn build:lambda` and `yarn package:lambda` (TypeScript scripts in `src/scripts/`)
- **No Backward Compatibility**: This is a single-purpose application running once per day in Lambda. We don't maintain backward compatibility - feel free to refactor, modernize, and improve code without worrying about breaking changes for external consumers.

## Shell Scripts & Development Environment

- **Platform**: macOS is the primary development platform
- **Shell**: Prefer **zsh** for new shell scripts (macOS default since Catalina 10.15)
  - Use `#!/bin/zsh` shebang for new scripts
  - For Lambda-related build/deployment scripts, prefer zsh or Node.js/TypeScript
  - Use zsh-specific features when beneficial (e.g., better array handling, globbing)
- **Build/Deployment Scripts**: Complex build and deployment scripts are written in TypeScript (located in `src/scripts/`) rather than shell scripts for better maintainability and type safety
